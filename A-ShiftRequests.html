<!DOCTYPE html>
<html lang="en">
<head>
  <title>ALA/Admin-Shift-Requests</title>
  <link rel="stylesheet" type="text/css" href="CRUD-Styles.css">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
</head>
<body class="Admin-Dash">
  <div class="dash">
    <section class="menu">
      <nav class="nav-menu">
        <h1>ALA</h1>
        <div class="list">
          <h3>Shift Requests</h3>
          <ul>
            <li><a href="Admin-dash.html">Dashboard</a></li>
            <li><a href="Admin-Profile.html">Profile</a></li>
            <li><a href="A-ShiftRequests.html">Shift Requests</a></li>
            <li><a href="A-RequestOff.html">Request Offs</a></li>
            <li><a href="A-Payroll.html">Payroll</a></li>
            <li><a href="Login.html">Logout</a></li>
          </ul>
        </div>
      </nav>
    </section>

    <section class="dashboard-content">
      <div class="mobile-nav">
          
            <div class="dropdown">
                <button class="dropbtn" aria-label="Toggle menu">
                &#9776; <!-- Hamburger icon -->
                </button>
                
                <div class="dropdown-content">
                     <a href="Admin-dash.html">Dashboard</a>
                     <a href="Admin-Profile.html">Profile</a>
                     <a href="A-ShiftRequests.html">Shift Requests</a>
                     <a href="A-RequestOff.html">Request Offs</a>
                     <a href="A-Payroll.html">Payroll</a>
                     <a href="Login.html">Logout</a>
                </div>
            </div>
            <h1>ALA | Dashboard</h1>  
        </div>
      <div class="dashboard-message">
        <h1>Your Employee Shift Requests</h1>
        <p>Review and Manage Your Shift Requests Below.</p>
      </div>

      <!-- EMPLOYEE SHIFT REQUESTS -->
      <div class="employee-requests">
        <div class="request-summary">
          <h2>Employee Shift Requests</h2>
          <table>
            <tr>
              <th>Approved Requests</th>
              <th>Denied Requests</th>
              <th>Pending Requests</th>
            </tr>
            <tr>
              <td id="approved-count">0</td>
              <td id="denied-count">0</td>
              <td id="pending-count">0</td>
            </tr>
          </table>
        </div>

        <div class="all-requests">
          <div class="all-requests-header">
            <h3>All Shift Requests</h3>
          </div>

          <table id="request-table">
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Shift Type</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <!-- CREATE OPEN SHIFTS -->
      <div class="employee-requests">
        <div class="request-summary">
          <h2>Create Open Shifts</h2>
          <table>
            <tr>
              <th>Taken Shifts</th>
              <th>Open Shifts</th>
            </tr>
            <tr>
              <td id="Taken-count">0</td>
              <td id="Open-count">0</td>
            </tr>
          </table>
        </div>

        <div class="all-requests">
          <div class="all-requests-header">
            <h3>Create Shifts</h3>
            <button id="request-button">Create Shift</button>
          </div>

          <div class="make-request">
            <form id="rform">
              <label for="shift-type">Shift Type:</label>
              <select id="shift-type" name="shift-type" required>
                <option value="Morning">Morning Shift</option>
                <option value="Afternoon">Afternoon Shift</option>
                <option value="Evening">Evening Shift</option>
                <option value="Weekend">Weekend Shift</option>
              </select>

              <div>
                <label for="start-date">Date:</label>
                <input type="date" id="date" name="date" required>
              </div>

              <button type="submit">Submit Shift</button>
            </form>
          </div>

          <table id="open-shift-table">
            <thead>
              <tr>
                <th>Employee ID</th>
                <th>Shift Type</th>
                <th>Date</th>
                <th>Status</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div id="all-employee-shifts" class="employee-requests">
        <h1>All Employee Shifts</h1>
        <div class="all-requests">
        <table id="admin-grouped-shift-table">
            <thead>
                <tr>
                    <th>User ID</th>
                    <th>Shift Type</th>
                    <th>Date</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table></div>
    </div>






    </section>
  </div>

<script>
/*login*/
const activeAdmin = JSON.parse(localStorage.getItem("activeUser"));
if (!activeAdmin) window.location.href = "Login.html";


let allRequests = JSON.parse(localStorage.getItem("all_shift_requests")) || [];
let openShifts = JSON.parse(localStorage.getItem("open_shifts")) || [];

/*loading the page*/
document.addEventListener("DOMContentLoaded", () => {
    loadShiftRequests();
    loadOpenShifts();
    updateOpenShiftCounts();
    setupCreateShiftButton();
});

/*show/hide form to create open shifts. triggers by clicking the Create Shift button*/
function setupCreateShiftButton() {
    const btn = document.getElementById("request-button");
    const form = document.querySelector(".make-request");
    form.style.display = "none";

    btn.addEventListener("click", () => {
        form.style.display = (form.style.display === "none") ? "block" : "none";
    });
}

/*loads in shift requests created by employees indluding: employeeID, type[vacation/sick/personal/other],
date of request, status [approved/declined/pending], actions [accept/decline]*/
function loadShiftRequests() {
    const tbody = document.querySelector("#request-table tbody");
    tbody.innerHTML = "";
    allRequests = JSON.parse(localStorage.getItem("all_shift_requests")) || [];

    allRequests.forEach(req => {
        let actionButtons = "";
        if (req.status === "Pending") {
            actionButtons = `
                <button class="approve-btn" data-id="${req.id}">Approve</button>
                <button class="decline-btn" data-id="${req.id}">Decline</button>
            `;
        }

        const row = document.createElement("tr");
        row.setAttribute("data-id", req.id);
        row.innerHTML = `
            <td>${req.userID}</td>
            <td>${req.type}</td>
            <td>${req.date}</td>
            <td>${req.status}</td>
            <td>${actionButtons}</td>
        `;
        tbody.appendChild(row);
    });

    attachRequestActionEvents();
    updateRequestCounts();
}
/*the approve and deny buttons related to the employee requests*/
function attachRequestActionEvents() {
    document.querySelectorAll(".approve-btn").forEach(btn => {
        btn.addEventListener("click", () => updateRequestStatus(Number(btn.dataset.id), "Approved"));
    });
    document.querySelectorAll(".decline-btn").forEach(btn => {
        btn.addEventListener("click", () => updateRequestStatus(Number(btn.dataset.id), "Denied"));
    });
}
/*displays shift request created by employee, includes: employee ID, shift type [morning, afternoon, night], 
status [approved/pending/denied]*/
function updateRequestStatus(id, status) {
    allRequests = allRequests.map(req => {
        if (req.id === id) req.status = status;
        return req;
    });

    localStorage.setItem("all_shift_requests", JSON.stringify(allRequests));

    allRequests.forEach(req => {
        const key = `shift_requests_${req.userID}`;
        let userRequests = JSON.parse(localStorage.getItem(key)) || [];
        userRequests = userRequests.map(r => r.id === req.id ? { ...r, status: req.status } : r);
        localStorage.setItem(key, JSON.stringify(userRequests));
    });

    loadShiftRequests();
}
/*updates the employee shift approved/denied/pending counter at the top of Employee Shift Requests card*/
function updateRequestCounts() {
    const approved = allRequests.filter(r => r.status === "Approved").length;
    const denied = allRequests.filter(r => r.status === "Denied").length;
    const pending = allRequests.filter(r => r.status === "Pending").length;

    document.getElementById("approved-count").textContent = approved;
    document.getElementById("denied-count").textContent = denied;
    document.getElementById("pending-count").textContent = pending;
}

/*for creating shifts, bottom half is for hiding the create shift form unless the "create shift" button has been clicked*/
document.getElementById("rform").addEventListener("submit", function(e) {
    e.preventDefault();
    const type = document.getElementById("shift-type").value;
    const date = document.getElementById("date").value;

    const newShift = {
        id: Date.now(),
        type: type,
        date: date,
        status: "Open"
    };

    openShifts.push(newShift);
    localStorage.setItem("open_shifts", JSON.stringify(openShifts));

    loadOpenShifts();
    updateOpenShiftCounts();

    document.querySelector(".make-request").style.display = "none";
    this.reset();
});

/*load created shift into Create Shifts table, it will include information such as shift type, date , status (open/taken
and actions (delete button). */
function loadOpenShifts() {
    openShifts = JSON.parse(localStorage.getItem("open_shifts")) || [];
    const tbody = document.querySelector("#open-shift-table tbody");
    tbody.innerHTML = "";

    openShifts.forEach(shift => {
        const employeeID = shift.employeeID ? shift.employeeID : "â€”";

        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${employeeID}</td>
            <td>${shift.type}</td>
            <td>${shift.date}</td>
            <td>${shift.status}</td>
            <td><button class="delete-btn" data-id="${shift.id}">Delete</button></td>
        `;
        tbody.appendChild(row);
    });

    attachOpenShiftDelete();
}
/*lets the admin delete the shift after it has been posted*/
function attachOpenShiftDelete() {
    document.querySelectorAll(".delete-btn").forEach(btn => {
        btn.addEventListener("click", function() {
            const id = Number(this.dataset.id);
            openShifts = openShifts.filter(s => s.id !== id);
            localStorage.setItem("open_shifts", JSON.stringify(openShifts));
            loadOpenShifts();
            updateOpenShiftCounts();
        });
    });
}
/*updates the taken and open shift counters at the top of the card based on open/take shifts*/
function updateOpenShiftCounts() {
    const open = openShifts.filter(s => s.status === "Open").length;
    const taken = openShifts.filter(s => s.status === "Taken").length;

    document.getElementById("Open-count").textContent = open;
    document.getElementById("Taken-count").textContent = taken;
}





document.addEventListener("DOMContentLoaded", () => {
    loadGroupedShiftsByUser();
});

function loadGroupedShiftsByUser() {
    const tbody = document.querySelector("#admin-grouped-shift-table tbody");
    tbody.innerHTML = "";

 /*load requests*/
    const allRequests = JSON.parse(localStorage.getItem("all_shift_requests")) || [];
    const approved = allRequests
        .filter(r => r.status === "Approved")
        .map(r => ({
            userID: r.userID,
            type: r.type,
            date: r.date
        }));

  /*Load all taken shifts*/
    const openShifts = JSON.parse(localStorage.getItem("open_shifts")) || [];
    const taken = openShifts
        .filter(s => s.status === "Taken")
        .map(s => ({
            userID: s.employeeID,
            type: s.type,
            date: s.date
        }));

   /*combine by userID*/
    const combined = [...approved, ...taken];

    const grouped = combined.reduce((acc, shift) => {
        if (!acc[shift.userID]) acc[shift.userID] = [];
        acc[shift.userID].push({ type: shift.type, date: shift.date });
        return acc;
    }, {});

   
    Object.keys(grouped).forEach(userID => {
        const shifts = grouped[userID];

        
        const firstRow = document.createElement("tr");
        firstRow.innerHTML = `
            <td rowspan="${shifts.length}">${userID}</td>
            <td>${shifts[0].type}</td>
            <td>${shifts[0].date}</td>
        `;
        tbody.appendChild(firstRow);

        
        for (let i = 1; i < shifts.length; i++) {
            const row = document.createElement("tr");
            row.innerHTML = `
                <td>${shifts[i].type}</td>
                <td>${shifts[i].date}</td>
            `;
            tbody.appendChild(row);
        }
    });
}

</script>

</body>
</html>
